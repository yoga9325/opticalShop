<div *ngIf="product" class="product-detail-page">
  <div class="product-detail-container">
    <!-- Left Side - Image Gallery -->
    <div class="product-gallery">
      <div class="main-image">
        <img [src]="selectedImage || product.imageUrl || 'assets/images/frame-1.svg'" [alt]="product.name" />
      </div>
      <div class="thumbnail-images">
        <img [src]="product.imageUrl || 'assets/images/frame-1.svg'" [alt]="product.name" class="thumbnail"
          [class.active]="selectedImage === product.imageUrl" (click)="selectedImage = product.imageUrl">
        <img [src]="product.imageUrl || 'assets/images/frame-1.svg'" [alt]="product.name + ' side'" class="thumbnail"
          (click)="selectedImage = product.imageUrl">
      </div>
    </div>

    <!-- Right Side - Product Information -->
    <div class="product-info">
      <!-- Brand & Name -->
      <div class="product-header">
        <div class="brand-badge">{{product.brand || 'Lenskart Air'}}</div>
        <h1 class="product-name">{{product.name}}</h1>
        <p class="product-subtitle">{{product.frameType || 'Full Rim'}} • {{product.frameShape || 'Square'}}</p>
      </div>

      <!-- Rating Display -->
      <div class="rating-display">
        <div class="stars-display">
          <span *ngFor="let star of [1,2,3,4,5]" class="star" [class.filled]="star <= averageRating">★</span>
        </div>
        <span class="rating-text">{{averageRating | number:'1.1-1'}} ({{ratingCount}} ratings)</span>
      </div>

      <!-- Price Section -->
      <div class="price-section">
        <div class="price-row">
          <span class="current-price">₹{{totalPrice}}</span>
          <span class="original-price" *ngIf="product.mPrice">₹{{product.mPrice}}</span>
          <span class="discount-badge" *ngIf="product.mPrice">{{getDiscount()}}% OFF</span>
        </div>
        <p class="tax-info">+ ₹50 Shipping Charges</p>
      </div>

      <!-- Color Options -->
      <div class="color-section" *ngIf="product.color">
        <p class="section-label">Color: <strong>{{product.color}}</strong></p>
        <div class="color-options">
          <div class="color-option active" [style.background-color]="getColorCode(product.color)"></div>
        </div>
      </div>

      <!-- Lens Selection -->
      <div class="selection-section" *ngIf="lenses.length > 0">
        <label>Select Lens:</label>
        <select [(ngModel)]="selectedLens" (change)="updateTotalPrice()" class="form-select">
          <option [ngValue]="null">Frame Only (No Lens)</option>
          <option *ngFor="let lens of lenses" [ngValue]="lens">
            {{lens.name}} (+ ₹{{lens.price}})
          </option>
        </select>
        <p class="small-desc" *ngIf="selectedLens">{{selectedLens.description}}</p>
      </div>

      <!-- Coating Selection -->
      <div class="selection-section" *ngIf="coatings.length > 0 && selectedLens">
        <label>Select Coating:</label>
        <select [(ngModel)]="selectedCoating" (change)="updateTotalPrice()" class="form-select">
          <option [ngValue]="null">No Extra Coating</option>
          <option *ngFor="let coating of coatings" [ngValue]="coating">
            {{coating.name}} (+ ₹{{coating.price}})
          </option>
        </select>
        <p class="small-desc" *ngIf="selectedCoating">{{selectedCoating.description}}</p>
      </div>

      <!-- Action Buttons -->
      <div class="action-buttons">
        <button class="btn btn-primary btn-large" (click)="addToCart()">
          <i class="bi bi-cart-plus"></i> Add to Cart
        </button>
        <button class="btn btn-secondary btn-large" (click)="addToWishlist()">
          <i class="bi bi-heart"></i> Wishlist
        </button>
      </div>

      <!-- Try On Button -->
      <button class="btn btn-try-on" (click)="showTryOnMessage()">
        <i class="bi bi-camera"></i> Try On
      </button>

      <!-- User Rating Section -->
      <!-- User Review Section -->
      <div class="user-rating-section">
        <h3 class="section-title">Customer Reviews</h3>

        <!-- Write a Review -->
        <div class="write-review" *ngIf="auth.isLoggedIn()">
          <h4 class="subsection-title">Write a Review</h4>
          
          <!-- Star Rating Input -->
          <div class="rating-input-group">
            <span class="label">Your Rating:</span>
            <div class="stars-input">
              <span *ngFor="let star of [1,2,3,4,5]" class="star clickable" [class.filled]="star <= userRating"
                [class.hover]="star <= hoverRating" (click)="submitRating(star); $event.stopPropagation()"
                (mouseenter)="hoverRating = star" (mouseleave)="hoverRating = 0">★</span>
            </div>
            <span class="rating-value" *ngIf="userRating > 0">{{userRating}}/5</span>
          </div>

          <!-- Review Message -->
          <div class="review-form">
            <textarea [(ngModel)]="reviewMessage" placeholder="Share your experience (optional)" class="review-textarea" rows="3"></textarea>
            
            <!-- Image Upload -->
             <div class="image-upload">
              <label class="upload-btn">
                <i class="bi bi-camera"></i> Add Photos
                <input type="file" multiple (change)="onFileSelected($event)" accept="image/*" hidden>
              </label>
              <div class="selected-images-preview" *ngIf="imagePreviews.length > 0">
                <div class="preview-item" *ngFor="let img of imagePreviews">
                  <img [src]="img" alt="Preview">
                </div>
              </div>
            </div>

            <button class="btn-submit-review" (click)="submitRating(userRating)" [disabled]="userRating === 0">
              Submit Review
            </button>
          </div>
        </div>

        <p class="login-prompt" *ngIf="!auth.isLoggedIn()">
          <a (click)="auth.triggerLoginModal(); $event.stopPropagation()" class="link-login">Login</a> to write a review
        </p>

        <!-- Reviews List -->
        <div class="reviews-list">
          <div class="review-item" *ngFor="let review of reviews">
            <div class="review-header">
              <div class="reviewer-avatar">{{review.id % 10}}</div> <!-- Placeholder avatar -->
              <div class="review-meta">
                <span class="reviewer-name">User {{review.userId}}</span> <!-- Ideally fetch username -->
                <div class="stars-display small">
                  <span *ngFor="let star of [1,2,3,4,5]" class="star" [class.filled]="star <= review.rating">★</span>
                </div>
              </div>
              <span class="review-date">Verified Purchase</span>
            </div>
            <p class="review-text" *ngIf="review.reviewMessage">{{review.reviewMessage}}</p>
            <div class="review-images" *ngIf="review.ratingImages && review.ratingImages.length > 0">
              <img *ngFor="let img of review.ratingImages" [src]="'data:image/jpeg;base64,' + img.picByte" class="review-img" alt="User Image" (click)="openImage('data:image/jpeg;base64,' + img.picByte)">
            </div>
          </div>
          <div class="no-reviews" *ngIf="reviews.length === 0">
            No reviews yet. Be the first to review this product!
          </div>
        </div>
      </div>

      <!-- Image Lightbox Modal -->
      <div class="image-lightbox" *ngIf="selectedReviewImage" (click)="closeImage()">
        <span class="close-lightbox">&times;</span>
        <img [src]="selectedReviewImage" class="lightbox-content" (click)="$event.stopPropagation()">
      </div>

      <!-- Technical Information -->
      <div class="technical-info">
        <div class="info-header" (click)="showTechnicalInfo = !showTechnicalInfo">
          <h3>Technical Information</h3>
          <i class="bi" [class.bi-chevron-down]="!showTechnicalInfo" [class.bi-chevron-up]="showTechnicalInfo"></i>
        </div>
        <div class="info-content" *ngIf="showTechnicalInfo">
          <div class="info-row">
            <span class="info-label">Product Id</span>
            <span class="info-value">{{product.id}}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Model No.</span>
            <span class="info-value">{{product.brand || 'LA'}} {{product.id}}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Frame Size</span>
            <span class="info-value">Medium</span>
          </div>
          <div class="info-row">
            <span class="info-label">Frame Width</span>
            <span class="info-value">134 mm</span>
          </div>
          <div class="info-row">
            <span class="info-label">Frame Type</span>
            <span class="info-value">{{product.frameType || 'Full Rim'}}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Material</span>
            <span class="info-value">{{product.material || 'Acetate'}}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Category</span>
            <span class="info-value">{{product.category}}</span>
          </div>
        </div>
      </div>

      <!-- Product Description -->
      <div class="product-description">
        <h3>Product Description</h3>
        <p>{{product.description}}</p>
      </div>
    </div>
  </div>
</div>